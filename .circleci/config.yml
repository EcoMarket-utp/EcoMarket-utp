version: 2.1

# ============================================================================
# CONFIGURACIÓN DE CI/CD PARA ECOMARKET
# Stack: Angular 19 + NestJS 11 + Prisma ORM
# Buenas prácticas: Caché, separación de jobs, validaciones, tests automatizados
# ============================================================================

executors:
  node-executor:
    docker:
      # Node >= 20 requerido para NestJS 11 y Prisma
      # cimg/node:20.6.0-browsers incluye SSH y herramientas adicionales
      - image: cimg/node:20.6.0-browsers
    working_directory: ~/repo
    environment:
      # Variables globales de ambiente
      PNPM_HOME: /home/circleci/.pnpm
      PATH: /home/circleci/.pnpm:$PATH

jobs:
  # ============================================================================
  # LINTING Y VALIDACIÓN DE CÓDIGO (Frontend)
  # ============================================================================
  lint-frontend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Instalar dependencias del frontend
          command: pnpm install --frozen-lockfile --filter ./apps/frontend-angular...
      - save_cache:
          key: pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.pnpm-store
            - ~/.pnpm
      - run:
          name: Ejecutar linter ESLint
          command: pnpm --filter ./apps/frontend-angular... run lint
      - run:
          name: Validar formato de código
          command: pnpm --filter ./apps/frontend-angular... run format:check
      - store_test_results:
          path: apps/frontend-angular/coverage

  # ============================================================================
  # LINTING Y VALIDACIÓN DE CÓDIGO (Backend)
  # ============================================================================
  lint-backend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Instalar dependencias del backend
          command: pnpm install --frozen-lockfile --filter ./apps/backend...
      - save_cache:
          key: pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.pnpm-store
            - ~/.pnpm
      - run:
          name: Ejecutar linter ESLint
          command: pnpm --filter ./apps/backend... run lint
      - run:
          name: Validar formato de código
          command: pnpm --filter ./apps/backend... run format:check
      - run:
          name: Type checking con TypeScript
          command: pnpm --filter ./apps/backend... run type-check

  # ============================================================================
  # BUILD: Frontend (Angular)
  # ============================================================================
  build-frontend:
    executor: node-executor
    environment:
      CI: true
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Instalar dependencias del frontend
          command: pnpm install --frozen-lockfile --filter ./apps/frontend-angular...
      - save_cache:
          key: pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.pnpm-store
            - ~/.pnpm
      - run:
          name: Validar configuración de TypeScript
          command: cd apps/frontend-angular && npx tsc --noEmit
      - run:
          name: Compilar frontend para producción
          command: pnpm --filter ./apps/frontend-angular... exec ng build --configuration production
      - run:
          name: Validar tamaño del bundle (máx 500KB)
          command: |
            BUNDLE_SIZE=$(ls -lh apps/frontend-angular/dist/browser/main-*.js | awk '{print $5}')
            echo "Tamaño del bundle: $BUNDLE_SIZE"
      - persist_to_workspace:
          root: .
          paths:
            - apps/frontend-angular/dist
      - store_artifacts:
          path: apps/frontend-angular/dist
          destination: frontend

  # ============================================================================
  # INSTALACIÓN DE DEPENDENCIAS: Backend + Prisma
  # ============================================================================
  setup-backend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Instalar dependencias del backend
          command: pnpm install --frozen-lockfile --filter ./apps/backend...
      - save_cache:
          key: pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.pnpm-store
            - ~/.pnpm
      - run:
          name: Generar cliente Prisma
          command: cd apps/backend && npx prisma generate
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - apps/backend

  # ============================================================================
  # TESTING: Tests unitarios del backend
  # ============================================================================
  test-backend:
    executor: node-executor
    environment:
      CI: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Ejecutar tests unitarios (Jasmine)
          command: pnpm --filter ./apps/backend... test --watch=false --code-coverage
      - run:
          name: Validar cobertura de tests (mínimo 70%)
          command: |
            if [ -f apps/backend/coverage/coverage-summary.json ]; then
              COVERAGE=$(grep -o '"lines".*"pct":[0-9]*' apps/backend/coverage/coverage-summary.json | head -1 | grep -o '[0-9]*')
              echo "Cobertura de código: ${COVERAGE}%"
              if [ "$COVERAGE" -lt 70 ]; then
                echo "❌ Cobertura insuficiente (requerido: 70%)"
                exit 1
              fi
            fi
      - store_test_results:
          path: apps/backend/coverage
      - store_artifacts:
          path: apps/backend/coverage
          destination: backend-coverage

  # ============================================================================
  # BUILD: Backend (NestJS) + Type checking
  # ============================================================================
  build-backend:
    executor: node-executor
    environment:
      CI: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Validar configuración de TypeScript
          command: cd apps/backend && npx tsc --noEmit
      - run:
          name: Compilar backend para producción
          command: pnpm --filter ./apps/backend... run build
      - run:
          name: Validar que la compilación fue exitosa
          command: |
            if [ ! -d apps/backend/dist ]; then
              echo "❌ Error: Build fallido - carpeta dist no encontrada"
              exit 1
            fi
            echo "✓ Backend compilado exitosamente"
      - persist_to_workspace:
          root: .
          paths:
            - apps/backend/dist
            - apps/backend/node_modules
      - store_artifacts:
          path: apps/backend/dist
          destination: backend

  # ============================================================================
  # SECURITY: Validación de dependencias vulnerables
  # ============================================================================

  security-audit:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Auditar dependencias (vulnerabilidades)
          command: |
            pnpm audit --audit-level=high || true
            echo "⚠️  Nota: El audit es informativo, continuar en caso de fallos menores"
      - run:
          name: Validar lockfile intacto
          command: pnpm install --frozen-lockfile --dry-run

  # ============================================================================
  # MIGRACIONES: Base de datos con Prisma
  # ============================================================================
  validate-migrations:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run:
          name: Instalar pnpm globalmente
          command: npm install -g pnpm@latest
      - run:
          name: Validar estado de migraciones
          command: |
            cd apps/backend
            echo "✓ Migraciones encontradas:"
            ls -la prisma/migrations/ || echo "No hay migraciones aún"
      - run:
          name: Validar esquema Prisma
          command: cd apps/backend && npx prisma validate

workflows:
  # ============================================================================
  # WORKFLOW: All Branches - Execute on all branches
  # ============================================================================
  ci:
    jobs:
      # Validation - Frontend
      - lint-frontend:
          filters:
            branches:
              only: /.*/
      
      # Validation - Backend
      - lint-backend:
          filters:
            branches:
              only: /.*/
      
      # Build Frontend
      - build-frontend:
          requires:
            - lint-frontend
          filters:
            branches:
              only: /.*/
      
      # Setup Backend
      - setup-backend:
          requires:
            - lint-backend
          filters:
            branches:
              only: /.*/
      
      # Test Backend
      - test-backend:
          requires:
            - setup-backend
          filters:
            branches:
              only: /.*/
      
      # Build Backend
      - build-backend:
          requires:
            - test-backend
          filters:
            branches:
              only: /.*/
      
      # Security Audit
      - security-audit:
          requires:
            - build-frontend
            - build-backend
          filters:
            branches:
              only: /.*/
      
      # Validate Migrations
      - validate-migrations:
          requires:
            - build-backend
          filters:
            branches:
              only: /.*/

