version: 2.1

executors:
  node-exec:
    docker:
      # Use Node >= 20 because some dependencies (Nest 11 / Prisma) require Node >= 20
      - image: cimg/node:20.6.0
    working_directory: ~/repo

jobs:
  # ---------- FRONTEND: build only (deployment via Render UI) ----------
  build-frontend:
    executor: node-exec
    environment:
      CI: true
    steps:
      - checkout
      - run:
          name: Disable corepack if present
          command: |
            if command -v corepack >/dev/null 2>&1; then
              corepack disable || true
            fi
            # Ensure any locally installed node_modules bins will be found in later steps
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
      - run:
          name: Ensure pnpm and install frontend deps (workspace-aware)
          command: |
            # Run installs from repo root and use --filter so pnpm uses the workspace lockfile
            # Install pnpm locally if not present to avoid global permission errors
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "pnpm not found — installing locally via npm (no sudo)"
              npm install pnpm --no-save
            fi
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
            # Install only deps required for the frontend package but let pnpm read the root lockfile
            pnpm install --frozen-lockfile --filter ./apps/frontend-angular...
      - run:
          name: Build frontend
          command: |
            # Run the build for the frontend package via workspace filter
            pnpm --filter ./apps/frontend-angular... exec ng build --configuration production
      - store_artifacts:
          path: apps/frontend-angular/dist
          destination: frontend

  # ---------- BACKEND: install deps & run prisma migrate ----------
  install-backend:
    executor: node-exec
    steps:
      - checkout
      - run:
          name: Disable corepack if present
          command: |
            if command -v corepack >/dev/null 2>&1; then
              corepack disable || true
            fi
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
      - run:
          name: Ensure pnpm and install backend deps (workspace-aware)
          command: |
            # Install pnpm locally if not present to avoid global permission errors
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "pnpm not found — installing locally via npm (no sudo)"
              npm install pnpm --no-save
            fi
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
            # Install only backend deps but let pnpm read the root lockfile
            pnpm install --no-frozen-lockfile --filter ./apps/backend...
      - run:
          name: Generate Prisma client
          command: |
            # Generate Prisma client so @prisma/client files exist for tests/build
            cd apps/backend
            npx prisma generate
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - apps/backend

  # ---------- TEST + BUILD + JAR (condicional para proyectos Java) ----------
  test-build-jar:
    executor: node-exec
    environment:
      CI: true
    steps:
      - checkout
      - run:
          name: Disable corepack if present
          command: |
            if command -v corepack >/dev/null 2>&1; then
              corepack disable || true
            fi
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
      - run:
          name: Ensure pnpm and install backend deps (for test/build)
          command: |
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "pnpm not found — installing locally via npm (no sudo)"
              npm install pnpm --no-save
            fi
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
            pnpm install --no-frozen-lockfile --filter ./apps/backend...
      # Prisma client is generated in the install-backend job (persisted via workspace)
      - run:
          name: Ensure Prisma client exists (generate if missing)
          command: |
            cd apps/backend
            npx prisma generate || true
      - run:
          name: Run backend tests
          command: |
            pnpm --filter ./apps/backend... test
      - run:
          name: Build backend
          command: |
            pnpm --filter ./apps/backend... run build
      - run:
          name: Try to build a Java JAR if a Java project exists
          command: |
            if [ -f pom.xml ]; then
              apt-get update && apt-get install -y maven
              mvn -B package -DskipTests
            elif [ -f gradlew ] || [ -f build.gradle ]; then
              apt-get update && apt-get install -y default-jdk
              chmod +x ./gradlew || true
              if [ -f ./gradlew ]; then
                ./gradlew build
              else
                gradle build
              fi
            else
              echo "No Java build files found; skipping JAR generation"
            fi
      - run:
          name: Collect JAR artifacts (if any)
          command: |
            mkdir -p /tmp/artifacts
            # Copy common jar output locations
            find . -type f -name '*.jar' -exec cp {} /tmp/artifacts/ \; || true
      - store_artifacts:
          path: /tmp/artifacts
          destination: jars

  prisma-migrate:
    executor: node-exec
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Ensure pnpm and install backend deps (for migrate)
          command: |
            # Install pnpm locally if not present to avoid global permission errors
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "pnpm not found — installing locally via npm (no sudo)"
              npm install pnpm --no-save
            fi
            echo 'export PATH=$PWD/node_modules/.bin:$PATH' >> $BASH_ENV
            # Install only backend deps (no-frozen to avoid lockfile issues in CI)
            pnpm install --no-frozen-lockfile --filter ./apps/backend...
      - run:
          name: Run Prisma migrations (deploy)
          command: |
            cd apps/backend
            # DATABASE_URL must estar en Environment Variables de CircleCI
            npx prisma migrate deploy

workflows:
  build-and-test:
    jobs:
      - build-frontend
      - install-backend
      - test-build-jar:
          requires:
            - install-backend
      - prisma-migrate:
          requires:
            - test-build-jar

